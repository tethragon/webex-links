<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Builder v3.7</title>
    <style>
        :root { 
            --primary-blue: #003366; /* Arsakeio Dark Blue */
            --secondary-gold: #c5a059; /* Arsakeio Gold */
            --hover-blue: #e3f2fd; 
            --border-color: #e0e0e0; 
            --error-red: #d32f2f;
            --success-green: #2e7d32;
            --warning-orange: #f57c00;
        }

        * { box-sizing: border-box; }

        html, body {
            margin: 0;
            padding: 0;
            height: auto; 
            background: #eceff1; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
        }

        body { 
            padding: 10px;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding-bottom: 100px; 
        }

        h2 { 
            color: var(--primary-blue); 
            text-transform: uppercase; 
            margin: 10px 0 20px; 
            text-align: center; 
            font-size: 1.4rem;
            letter-spacing: 1px;
            border-bottom: 3px solid var(--secondary-gold);
            padding-bottom: 5px;
            display: inline-block;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-blue);
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loading-text { margin-top: 15px; color: var(--primary-blue); font-weight: bold; }

        /* Controls Area */
        .controls-area {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            align-items: flex-end; 
            gap: 20px;
            justify-content: center;
            border-top: 4px solid var(--primary-blue);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
        }

        .control-group label {
            font-weight: bold;
            color: var(--primary-blue);
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .select-row {
            display: flex;
            gap: 10px;
        }

        /* Inputs within Controls */
        .controls-area select {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
            min-width: 130px;
            text-align: center;
            background-color: #fff;
        }

        /* Separator */
        .vertical-sep {
            width: 1px;
            height: 50px;
            background-color: #ddd;
            margin: 0 10px;
        }

        /* General Selects */
        select {
            width: 100%;
            min-width: 150px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            cursor: pointer;
        }
        
        select:disabled {
            background-color: #e0e0e0;
            color: #888;
            cursor: not-allowed;
        }
        
        select:focus { 
            border-color: var(--primary-blue); 
            outline: 2px solid var(--hover-blue);
        }

        /* Multi-Select Highlight */
        .multi-selected {
            outline: 3px solid var(--warning-orange) !important;
            background-color: #fff3e0 !important;
        }

        /* Warnings */
        .no-teachers-warning {
            flex-basis: 100%;
            color: var(--error-red);
            font-weight: bold;
            text-align: center;
            padding: 10px;
            background: #ffebee;
            border: 1px solid var(--error-red);
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }

        /* --- ÎÎ•Î‘ Î£Î¤Î¥Î› Î“Î™Î‘ Î¤Î— ÎœÎ Î‘Î¡Î‘ Î•Î›Î•Î“Î§ÎŸÎ¥ (Bar & Score) --- */
        .validation-report {
                width: 100%;
                max-width: 1200px;
                background: white;
                border-radius: 8px;
                margin-bottom: 20px;
                /* Î‘Ï†Î±Î¹ÏÎ­ÏƒÎ±Î¼Îµ Ï„Î¿ display: none Î±Ï€ÏŒ ÎµÎ´Ï, Ï„Î¿ ÎµÎ»Î­Î³Ï‡Î¿Ï…Î¼Îµ Î´Ï…Î½Î±Î¼Î¹ÎºÎ¬ */
                display: none; 
                box-shadow: 0 4px 10px rgba(0,0,0,0.1);
                border: 1px solid var(--border-color);
                overflow: hidden;
        }

        .validation-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px 20px;
                background: #fcfcfc;
                cursor: pointer;
                transition: background 0.2s;
                border-bottom: 1px solid transparent;
        }

        .validation-header:hover { background: var(--hover-blue); }
        .validation-header.open { border-bottom: 1px solid var(--border-color); background: #fff; }

        .header-left { display: flex; align-items: center; gap: 15px; }

        .header-title {
                font-weight: bold;
                color: var(--primary-blue);
                font-size: 1.05rem;
                text-transform: uppercase;
        }

        .score-badge {
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 0.9rem;
                font-weight: bold;
                color: white;
                transition: all 0.3s;
        }
        .score-badge.success { background-color: var(--success-green); }
        .score-badge.error { background-color: var(--error-red); }

        /* Î¤Î¿ Î²ÎµÎ»Î¬ÎºÎ¹ */
        .chevron {
                width: 24px; height: 24px; fill: var(--primary-blue);
                transition: transform 0.3s ease;
        }
        .chevron.rotate { transform: rotate(180deg); }

        /* Î¤Î¿ Ï€ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿ Ï€Î¿Ï… Î±Î½Î¿Î¹Î³Î¿ÎºÎ»ÎµÎ¯Î½ÎµÎ¹ */
        .validation-content {
                display: none;
                padding: 20px;
                background: white;
                animation: slideDown 0.3s ease-out;
        }

            @keyframes slideDown {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }

        /* Î”Î¹ÏŒÏÎ¸Ï‰ÏƒÎ· ÏƒÏ„Î¿ Grid Î³Î¹Î± Î½Î± Î¼Î·Î½ Î­Ï‡ÎµÎ¹ Î´Î¹Ï€Î»ÏŒ border */
        .validation-grid { border-top: none; padding-top: 0; }
        
        .assignment-warning {
            color: var(--error-red);
            font-weight: bold;
            margin-bottom: 15px;
            padding: 10px;
            background: #ffebee;
            border-left: 5px solid var(--error-red);
            display: none;
        }

        .validation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 10px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        .validation-item {
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            background: #f5f5f5;
        }
        .validation-item.error { background-color: #fff5f5; color: var(--error-red); border-left: 4px solid var(--error-red); }
        .validation-item.success { background-color: #f1f8f1; color: var(--success-green); border-left: 4px solid var(--success-green); }

        /* Card Styles */
        .card {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            margin-bottom: 30px; 
            scroll-margin-top: 20px;
        }

        .card-header {
            background-color: var(--primary-blue);
            color: white;
            padding: 10px 15px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .table-scroll-area { overflow: auto; max-height: 75vh; width: 100%; }
        .table-full-view { width: 100%; overflow-x: auto; }

        table { border-collapse: separate; border-spacing: 0; width: 100%; min-width: 800px; }
        th, td {
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            padding: 6px; 
            text-align: center; 
            font-size: 0.9rem; 
        }

        #schedule-table th { background: var(--primary-blue); color: white; position: sticky; top: 0; z-index: 20; }
        #schedule-table th:first-child { left: 0; z-index: 30; }
        #schedule-table td:first-child { position: sticky; left: 0; z-index: 15; background: #fcfcfc; font-weight: bold; white-space: nowrap; }

        #assignments-table th { background: #455a64; color: white; text-align: left; padding: 10px; }
        #assignments-table td { text-align: left; padding: 10px 8px; vertical-align: middle; }
        #assignments-body tr:nth-child(even) { background-color: #f2f2f5; }

        .missing-assignment { border: 2px solid var(--error-red) !important; background-color: #fff5f5; }
        .teacher-mismatch { color: var(--error-red) !important; font-weight: bold; background-color: #fff0f0; }

        .teacher-row-container { display: flex; flex-direction: column; gap: 5px; }
        .teacher-input-group { display: flex; gap: 5px; align-items: center; }
        
        .btn-add, .btn-remove {
            width: 30px; height: 30px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-add { background-color: #28a745; color: white; }
        .btn-remove { background-color: #dc3545; color: white; }

        /* Footer */
        .main-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; border-top: 1px solid #ddd; padding: 10px;
            display: flex; justify-content: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100;
        }

        .footer-inner {
            width: 100%; max-width: 1200px;
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 15px;
        }

        .footer-status-area { display: flex; gap: 15px; align-items: center; }
        
        .status-box {
            background: #757575; color: white; padding: 8px 16px; border-radius: 8px;
            font-weight: bold; font-size: 0.9rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;
            cursor: pointer; user-select: none;
        }
        
        .status-box:hover { transform: translateY(-2px); filter: brightness(1.15); }
        .status-box.success { background-color: var(--success-green); }
        .status-box.warning { background-color: var(--warning-orange); }
        .status-box.error { background-color: var(--error-red); }
        
        .footer-actions-area { display: flex; gap: 10px; align-items: center; }
        
        .btn-footer {
            color: white; border: none; padding: 10px 20px; font-size: 0.9rem; border-radius: 50px; 
            cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.15); transition: all 0.2s;
        }

        .btn-footer:hover { transform: translateY(-2px); filter: brightness(1.15); }
        .export-btn { background-color: var(--primary-blue); }
        .import-btn { background-color: #0277bd; }
        .reset-btn { background-color: #c62828; }
        .btn-footer svg { width: 18px; height: 18px; fill: currentColor; }
        
        .save-indicator {
            position: absolute; right: 20px; top: -40px; background: #333; color: #fff;
            padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; opacity: 0; pointer-events: none;
            transition: opacity 0.5s;
        }
        
        @media screen and (max-width: 800px) {
            .footer-inner { justify-content: center; flex-direction: column; gap: 10px; }
            .controls-area { flex-direction: column; align-items: center; }
            .vertical-sep { width: 100%; height: 1px; margin: 10px 0; }
        }
        /* --- CSS Î“Î™Î‘ Î¤ÎŸ DISMISSIBLE INFO BOX --- */
        .info-tip-box {
            background-color: #e3f2fd; /* Î‘Ï€Î±Î»ÏŒ Î¼Ï€Î»Îµ Arsakeio */
            color: var(--primary-blue);
            padding: 10px 20px;
            border-bottom: 1px solid #bbdefb;
            display: none; /* ÎšÏÏ…Ï†ÏŒ Î±ÏÏ‡Î¹ÎºÎ¬, Ï„Î¿ Î±Î½Î¿Î¯Î³ÎµÎ¹ Î· JS Î±Î½ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎºÎ»ÎµÎ¯ÏƒÎµÎ¹ */
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            animation: fadeIn 0.5s;
        }

        .tip-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tip-close-btn {
            background: none;
            border: none;
            font-size: 1.4rem;
            color: #003366;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .tip-close-btn:hover {
            opacity: 1;
            color: var(--error-red);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="loader"></div>
        <div id="loading-text">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½...</div>
    </div>

    <h2>Î”Î—ÎœÎ™ÎŸÎ¥Î¡Î“Î™Î‘ Î Î¡ÎŸÎ“Î¡Î‘ÎœÎœÎ‘Î¤ÎŸÎ£</h2>

    <div class="controls-area">
        <div class="control-group">
            <label>Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±</label>
            <div class="select-row">
                <select id="region-select" onfocus="this.setAttribute('data-prev', this.value)" onchange="handleRegionChange(this)">
                    <option value="" disabled selected>Î ÎµÏÎ¹Î¿Ï‡Î®</option>
                </select>
                <select id="school-select" onfocus="this.setAttribute('data-prev', this.value)" onchange="handleSchoolChange(this)" disabled>
                    <option value="" disabled selected>Î£Ï‡Î¿Î»ÎµÎ¯Î¿</option>
                </select>
            </div>
        </div>

        <div class="vertical-sep"></div>

        <div class="control-group">
            <label>Î¤Î¬Î¾Î· / Î¤Î¼Î®Î¼Î±</label>
            <div class="select-row">
                <select id="grade-select" onchange="handleMainChange()">
                    <option value="" disabled selected>Î¤Î¬Î¾Î·</option>
                    <option value="Î‘">Î‘</option>
                    <option value="Î’">Î’</option>
                    <option value="Î“">Î“</option>
                    <option value="Î”">Î”</option>
                    <option value="Î•">Î•</option>
                    <option value="Î£Î¤">Î£Î¤</option>
                </select>
                <select id="section-select" onchange="handleMainChange()">
                    <option value="" disabled selected>Î¤Î¼Î®Î¼Î±</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                </select>
            </div>
        </div>
        
        <div id="no-teachers-msg" class="no-teachers-warning">
            Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Î¯ Î³Î¹Î± Ï„Î¿ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿ ÏƒÏ‡Î¿Î»ÎµÎ¯Î¿ ÏƒÏ„Î¿ Raw Data. <br> Î— ÎºÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· Î¼Î±Î¸Î·Î¼Î¬Ï„Ï‰Î½ Î±Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®Î¸Î·ÎºÎµ.
        </div>
    </div>

    <div id="validation-report" class="validation-report">
        <div class="validation-header" onclick="toggleValidation()">
            <div class="header-left">
                <span class="header-title" style="font-size: 0.95rem;">ÎœÎ‘Î˜Î—ÎœÎ‘Î¤Î‘ ÎœÎ• ÎŸÎ¡Î˜Î— Î”Î—Î›Î©Î£Î— Î©Î¡Î©Î:</span>
                <span id="validation-score-badge" class="score-badge error">- / -</span>
            </div>
            <svg id="validation-arrow" class="chevron" viewBox="0 0 24 24">
                <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
            </svg>
        </div>

        <div id="multi-select-tip" class="info-tip-box">
            <div class="tip-content">
                <span style="font-size: 1.2rem;">ğŸ’¡</span>
                <span><strong>Tip:</strong> ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎµÏ€Î¹Î»Î­Î¾ÎµÏ„Îµ Ï€Î¿Î»Î»Î¬ Ï€ÎµÎ´Î¯Î± Ï„Î±Ï…Ï„ÏŒÏ‡ÏÎ¿Î½Î± ÎºÏÎ±Ï„ÏÎ½Ï„Î±Ï‚ Ï€Î±Ï„Î·Î¼Î­Î½Î¿ Ï„Î¿ Ï€Î»Î®ÎºÏ„ÏÎ¿ <strong>CTRL</strong> + <strong>Click</strong>.</span>
            </div>
            <button class="tip-close-btn" onclick="dismissTip()" title="ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ ÎºÎ±Î¹ Î½Î± Î¼Î·Î½ ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯ Î¾Î±Î½Î¬">Ã—</button>
        </div>

        <div id="validation-content" class="validation-content">
            <div id="assignment-warning" class="assignment-warning">âš ï¸ Î Î¡ÎŸÎ£ÎŸÎ§Î—: Î¥Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î¼Î±Î¸Î®Î¼Î±Ï„Î± Ï‡Ï‰ÏÎ¯Ï‚ Î±Î½Î¬Î¸ÎµÏƒÎ· ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Ï!</div>
            <div style="margin-bottom: 15px; color: #555;">Î›ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚ Î©ÏÏÎ½ Î±Î½Î¬ ÎœÎ¬Î¸Î·Î¼Î±:</div>
            <div id="validation-grid" class="validation-grid"></div>
        </div>
    </div>

    <div id="card-schedule" class="card">
        <div class="card-header">Î©Î¡ÎŸÎ›ÎŸÎ“Î™ÎŸ Î Î¡ÎŸÎ“Î¡Î‘ÎœÎœÎ‘</div>
        <div class="table-scroll-area">
            <table id="schedule-table">
                <thead><tr id="header-row"></tr></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="card-assignments" class="card">
        <div class="card-header">Î‘ÎÎ‘Î˜Î•Î£Î•Î™Î£ Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎ©Î</div>
        <div class="table-full-view">
            <table id="assignments-table">
                <thead>
                    <tr>
                        <th style="width: 40%;">ÎœÎ¬Î¸Î·Î¼Î±</th>
                        <th style="width: 60%;">Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏŒÏ‚</th>
                    </tr>
                </thead>
                <tbody id="assignments-body">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="main-footer">
        <div class="footer-inner">
            <div class="save-indicator" id="save-msg">Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ</div>
            
            <div class="footer-status-area">
                <div id="status-hours" class="status-box warning" onclick="document.getElementById('card-schedule').scrollIntoView({behavior: 'smooth'})">
                    <span>Î©Î¡Î•Î£: 0/40</span>
                </div>
                
                <div id="status-subjects" class="status-box warning" onclick="document.getElementById('validation-report').scrollIntoView({behavior: 'smooth'})">
                    <span>ÎœÎ‘Î˜Î—ÎœÎ‘Î¤Î‘: -</span>
                </div>
                
                <div id="status-assign" class="status-box warning" onclick="document.getElementById('card-assignments').scrollIntoView({behavior: 'smooth'})">
                    <span>Î‘ÎÎ‘Î˜Î•Î£Î•Î™Î£: 0/0</span>
                </div>
            </div>

            <div class="footer-actions-area">
                <button class="btn-footer reset-btn" onclick="clearAllData()">
                    <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                    ÎšÎ‘Î˜Î‘Î¡Î™Î£ÎœÎŸÎ£
                </button>
                <input type="file" id="csv-input" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                <button class="btn-footer import-btn" onclick="triggerImport()">
                    <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" transform="rotate(180 12 12)"/></svg>
                    Î•Î™Î£Î‘Î“Î©Î“Î—
                </button>
                <button class="btn-footer export-btn" onclick="exportToCSV()">
                    <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                    Î•ÎÎ‘Î“Î©Î“Î—
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ==========================================
        // DATA LOADER & CONFIG
        // ==========================================
        const RAW_DAYS = `Î©Î¡Î‘,Î”Î•Î¥Î¤Î•Î¡Î‘,Î¤Î¡Î™Î¤Î—,Î¤Î•Î¤Î‘Î¡Î¤Î—,Î Î•ÎœÎ Î¤Î—,Î Î‘Î¡Î‘Î£ÎšÎ•Î¥Î—`;
        const RAW_TIMES = `8:10-8:55\n9:00-9:45\n10:00-10:45\n10:50-11:35\n11:45-12:25\n12:30-13:10\n13:25-14:05\n14:10-14:50`;
        const RAW_SUBJECTS = `Î‘Î“Î“Î›Î™ÎšÎ‘\nÎ‘Î“Î©Î“Î— Î¥Î“Î•Î™Î‘Î£\nÎ’' ÎÎ•ÎÎ— Î“Î›Î©Î£Î£Î‘\nÎ“Î•Î©Î“Î¡Î‘Î¦Î™Î‘\nÎ“Î¥ÎœÎÎ‘Î£Î¤Î™ÎšÎ—\nÎ•Î›Î›Î—ÎÎ™ÎšÎ‘\nÎ•Î›Î›Î—ÎÎ™ÎšÎ— Î Î‘Î¡Î‘Î”ÎŸÎ£Î—\nÎ•Î¡Î“. Î”Î•Î.\nÎ˜Î•Î‘Î¤Î¡Î™ÎšÎ— Î‘Î“Î©Î“Î—\nÎ˜Î¡Î—Î£ÎšÎ•Î¥Î¤Î™ÎšÎ‘\nÎ™Î£Î¤ÎŸÎ¡Î™Î‘\nÎšÎ‘Î›Î›Î™Î¤Î•Î§ÎÎ™ÎšÎ‘\nÎšÎ Î‘\nÎœÎ‘Î˜Î—ÎœÎ‘Î¤Î™ÎšÎ‘\nÎœÎ•Î›Î•Î¤Î— Î Î•Î¡Î™Î’Î‘Î›Î›ÎŸÎÎ¤ÎŸÎ£\nÎœÎŸÎ¥Î£Î™ÎšÎ—\nÎœÎ£/Î”Î£\nÎ Î›Î—Î¡ÎŸÎ¦ÎŸÎ¡Î™ÎšÎ—\nÎ¦Î™Î›Î‘ÎÎ‘Î“ÎÎ©Î£Î™Î‘\nÎ¦Î¥Î£Î™ÎšÎ—\nSHTEAM\nSOCIAL STUDIES`;
        const RAW_HOURS_RULES = `Î’' ÎÎ•ÎÎ— Î“Î›Î©Î£Î£Î‘,0,0,2,2,3,3\nÎ“Î¥ÎœÎÎ‘Î£Î¤Î™ÎšÎ—,4,4,3,3,3,3\nÎ™Î£Î¤ÎŸÎ¡Î™Î‘,0,0,2,2,2,2\nÎ¦Î¥Î£Î™ÎšÎ—,0,0,0,0,3,3\nÎœÎ•Î›Î•Î¤Î— Î Î•Î¡Î™Î’Î‘Î›Î›ÎŸÎÎ¤ÎŸÎ£,3,3,2,2,0,0\nÎšÎ‘Î›Î›Î™Î¤Î•Î§ÎÎ™ÎšÎ‘,2,2,2,2,1,1\nÎœÎ‘Î˜Î—ÎœÎ‘Î¤Î™ÎšÎ‘,5,5,5,5,5,5\nÎ•Î›Î›Î—ÎÎ™ÎšÎ‘,10,10,8,8,7,7\nÎ‘Î“Î“Î›Î™ÎšÎ‘,4,4,5,5,5,5\nÎ¦Î™Î›Î‘ÎÎ‘Î“ÎÎ©Î£Î™Î‘,1,1,1,1,1,1\nÎ•Î¡Î“. Î”Î•Î.,3,3,2,2,2,2\nÎœÎŸÎ¥Î£Î™ÎšÎ—,2,2,2,2,1,1\nÎ Î›Î—Î¡ÎŸÎ¦ÎŸÎ¡Î™ÎšÎ—,1,1,1,1,1,1\nÎšÎ Î‘,0,0,0,0,1,1\nÎ“Î•Î©Î“Î¡Î‘Î¦Î™Î‘,0,0,0,0,1,1\nSOCIAL STUDIES,0,0,0,0,1,1\nÎ‘Î“Î©Î“Î— Î¥Î“Î•Î™Î‘Î£,1,1,0,0,0,0\nÎ•Î›Î›Î—ÎÎ™ÎšÎ— Î Î‘Î¡Î‘Î”ÎŸÎ£Î—,1,1,0,0,0,0\nÎ˜Î•Î‘Î¤Î¡Î™ÎšÎ— Î‘Î“Î©Î“Î—,1,1,1,1,1,1\nÎ˜Î¡Î—Î£ÎšÎ•Î¥Î¤Î™ÎšÎ‘,0,0,2,2,1,1\nÎœÎ£/Î”Î£,1,1,1,1,1,1\nSHTEAM,1,1,1,1,0,0`;
        const RAW_SCHOOL_MAPPINGS = `Î¨Î¥Î§Î™ÎšÎŸ,1,2,3\nÎ•ÎšÎ‘Î›Î—,1,2,3\nÎ˜Î•Î£Î£Î‘Î›ÎŸÎÎ™ÎšÎ—,1\nÎ Î‘Î¤Î¡Î‘,1\nÎ™Î©Î‘ÎÎÎ™ÎÎ‘,1`;

        const PRIMARY_DATA_URL = "https://tethragon.github.io/webex-links/teachers_and_mappings.js";
        
        // =========================================================================
        //  !!! FALLBACK URL - Î•Î™Î£Î‘Î“Î•Î¤Î• Î¤ÎŸ URL Î•Î”Î© Î£Î¤Î—Î Î‘Î ÎŸ ÎšÎ‘Î¤Î© Î“Î¡Î‘ÎœÎœÎ— !!!
        // =========================================================================
        const FALLBACK_DATA_URL = "https://tethragon.github.io/webex-links/teachers_and_mappings.js"; 
        // =========================================================================

        function loadScript(url) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                // Cache busting using timestamp
                script.src = url + "?t=" + new Date().getTime();
                script.onload = () => resolve();
                script.onerror = () => reject();
                document.head.appendChild(script);
            });
        }

        async function loadExternalData() {
            const overlay = document.getElementById('loading-overlay');
            const statusText = document.getElementById('loading-text');

            try {
                statusText.innerText = "Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ (Î Î·Î³Î® 1)...";
                await loadScript(PRIMARY_DATA_URL);
                console.log("Data loaded from Primary Source");
                overlay.style.display = 'none';
                initApp();
            } catch (error) {
                console.warn("Primary source failed, trying fallback...");
                statusText.innerText = "Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ (Î Î·Î³Î® 2)...";
                try {
                    await loadScript(FALLBACK_DATA_URL);
                    console.log("Data loaded from Fallback Source");
                    overlay.style.display = 'none';
                    initApp();
                } catch (fallbackError) {
                    console.error("Critical: Both sources failed.");
                    statusText.style.color = "#d32f2f";
                    statusText.innerText = "Î£Î¦Î‘Î›ÎœÎ‘: Î‘Î´Ï…Î½Î±Î¼Î¯Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½.\nÎ•Î»Î­Î³Î¾Ï„Îµ Ï„Î· ÏƒÏÎ½Î´ÎµÏƒÎ® ÏƒÎ±Ï‚ ÎºÎ±Î¹ ÎºÎ¬Î½Ï„Îµ Î±Î½Î±Î½Î­Ï‰ÏƒÎ·.";
                    alert("Î£Î¦Î‘Î›ÎœÎ‘ Î£Î¥Î£Î¤Î—ÎœÎ‘Î¤ÎŸÎ£:\n\nÎ”ÎµÎ½ Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„Î® Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ· Ï„Ï‰Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Ï„Ï‰Î½ ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏÎ½ Î±Ï€ÏŒ ÎºÎ±Î¼Î¯Î± Ï€Î·Î³Î®.\n\nÎ Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î· ÏƒÏÎ½Î´ÎµÏƒÎ® ÏƒÎ±Ï‚ ÏƒÏ„Î¿ Î´Î¹Î±Î´Î¯ÎºÏ„Ï…Î¿.");
                }
            }
        }

        // ==========================================
        // DEBUG DATA
        // ==========================================
        const DEBUG_DATA_CSV = `Î©Î¡Î‘,Î”Î•Î¥Î¤Î•Î¡Î‘,Î¤Î¡Î™Î¤Î—,Î¤Î•Î¤Î‘Î¡Î¤Î—,Î Î•ÎœÎ Î¤Î—,Î Î‘Î¡Î‘Î£ÎšÎ•Î¥Î—\n8:10-8:55,Î•Î›Î›Î—ÎÎ™ÎšÎ‘,Î•Î›Î›Î—ÎÎ™ÎšÎ‘,Î‘Î“Î“Î›Î™ÎšÎ‘,Î’' ÎÎ•ÎÎ— Î“Î›Î©Î£Î£Î‘,ÎœÎ‘Î˜Î—ÎœÎ‘Î¤Î™ÎšÎ‘\n9:00-9:45,Î•Î›Î›Î—ÎÎ™ÎšÎ‘,Î•Î›Î›Î—ÎÎ™ÎšÎ‘,Î•Î›Î›Î—ÎÎ™ÎšÎ‘,Î“Î¥ÎœÎÎ‘Î£Î¤Î™ÎšÎ—,Î•Î›Î›Î—ÎÎ™ÎšÎ‘\n10:00-10:45,ÎœÎ‘Î˜Î—ÎœÎ‘Î¤Î™ÎšÎ‘,Î Î›Î—Î¡ÎŸÎ¦ÎŸÎ¡Î™ÎšÎ—,Î•Î›Î›Î—ÎÎ™ÎšÎ‘,ÎœÎ‘Î˜Î—ÎœÎ‘Î¤Î™ÎšÎ‘,Î•Î¡Î“. Î”Î•Î.\n10:50-11:35,Î“Î¥ÎœÎÎ‘Î£Î¤Î™ÎšÎ—,Î“Î¥ÎœÎÎ‘Î£Î¤Î™ÎšÎ—,ÎœÎ‘Î˜Î—ÎœÎ‘Î¤Î™ÎšÎ‘,ÎšÎ‘Î›Î›Î™Î¤Î•Î§ÎÎ™ÎšÎ‘,Î‘Î“Î“Î›Î™ÎšÎ‘\n11:45-12:25,Î¦Î¥Î£Î™ÎšÎ—,Î™Î£Î¤ÎŸÎ¡Î™Î‘,Î’' ÎÎ•ÎÎ— Î“Î›Î©Î£Î£Î‘,Î˜Î•Î‘Î¤Î¡Î™ÎšÎ— Î‘Î“Î©Î“Î—,Î¦Î¥Î£Î™ÎšÎ—\n12:30-13:10,Î‘Î“Î“Î›Î™ÎšÎ‘,Î‘Î“Î“Î›Î™ÎšÎ‘,ÎšÎ Î‘,Î‘Î“Î“Î›Î™ÎšÎ‘,ÎœÎ£/Î”Î£\n13:25-14:05,Î¦Î™Î›Î‘ÎÎ‘Î“ÎÎ©Î£Î™Î‘,ÎœÎ‘Î˜Î—ÎœÎ‘Î¤Î™ÎšÎ‘,ÎœÎŸÎ¥Î£Î™ÎšÎ—,Î“Î•Î©Î“Î¡Î‘Î¦Î™Î‘,Î™Î£Î¤ÎŸÎ¡Î™Î‘\n14:10-14:50,Î’' ÎÎ•ÎÎ— Î“Î›Î©Î£Î£Î‘,Î¦Î¥Î£Î™ÎšÎ—,Î•Î¡Î“. Î”Î•Î.,Î˜Î¡Î—Î£ÎšÎ•Î¥Î¤Î™ÎšÎ‘,SOCIAL STUDIES`;
        const DEBUG_ASSIGNMENTS_CSV = `Î¨Î¥Î§Î™ÎšÎŸ,2,Î£Î¤1,SOCIAL STUDIES,Î”Î—ÎœÎ—Î¤Î¡ÎŸÎ ÎŸÎ¥Î›ÎŸÎ¥ Î”Î—ÎœÎ—Î¤Î¡Î‘\nÎ¨Î¥Î§Î™ÎšÎŸ,2,Î£Î¤1,Î‘Î“Î“Î›Î™ÎšÎ‘,Î”Î—ÎœÎ—Î¤Î¡ÎŸÎ ÎŸÎ¥Î›ÎŸÎ¥ Î”Î—ÎœÎ—Î¤Î¡Î‘,ÎšÎ¥Î¡Î™Î‘ÎšÎ— ÎšÎ‘Î¤Î•Î¡Î™ÎÎ‘,ÎœÎ—Î›Î™ÎŸÎ ÎŸÎ¥Î›ÎŸÎ¥ Î–Î©Î—\nÎ¨Î¥Î§Î™ÎšÎŸ,2,Î£Î¤1,Î“Î‘Î›Î›Î™ÎšÎ‘,Î‘Î›Î•ÎÎŸÎ ÎŸÎ¥Î›ÎŸÎ¥ Î•Î™Î¡Î—ÎÎ—,Î’Î•ÎÎ‘Î¡Î”ÎŸÎ¥ Î§Î¡Î™Î£Î¤Î™ÎÎ‘\nÎ¨Î¥Î§Î™ÎšÎŸ,2,Î£Î¤1,Î“Î•Î¡ÎœÎ‘ÎÎ™ÎšÎ‘,Î¤Î£Î™Î¡ÎŸÎ¥ ÎŸÎ¥Î¡Î‘ÎÎ™Î‘\nÎ¨Î¥Î§Î™ÎšÎŸ,2,Î£Î¤1,Î“Î•Î©Î“Î¡Î‘Î¦Î™Î‘,Î Î•Î¤Î¡Î‘ÎšÎ—Î£ Î“Î•Î©Î¡Î“Î™ÎŸÎ£\nÎ¨Î¥Î§Î™ÎšÎŸ,2,Î£Î¤1,Î“Î¥ÎœÎÎ‘Î£Î¤Î™ÎšÎ—,ÎœÎ Î‘Î¡Î›Î‘Î£ ÎÎ™ÎšÎŸÎ›Î‘ÎŸÎ£\nÎ¨Î¥Î§Î™ÎšÎŸ,2,Î£Î¤1,Î•Î›Î›Î—ÎÎ™ÎšÎ‘,Î Î•Î¤Î¡Î‘ÎšÎ—Î£ Î“Î•Î©Î¡Î“Î™ÎŸÎ£\nÎ¨Î¥Î§Î™ÎšÎŸ,2,Î£Î¤1,Î•Î¡Î“. Î”Î•Î.,Î Î•Î¤Î¡Î‘ÎšÎ—Î£ Î“Î•Î©Î¡Î“Î™ÎŸÎ£\nÎ¨Î¥Î§Î™ÎšÎŸ,2,Î£Î¤1,Î˜Î•Î‘Î¤Î¡Î™ÎšÎ— Î‘Î“Î©Î“Î—,ÎšÎŸÎÎ¤ÎŸÎ¥ Î‘ÎÎ˜Î—\nÎ¨Î¥Î§Î™ÎšÎŸ,2,Î£Î¤1,Î˜Î¡Î—Î£ÎšÎ•Î¥Î¤Î™ÎšÎ‘,Î Î•Î¤Î¡Î‘ÎšÎ—Î£ Î“Î•Î©Î¡Î“Î™ÎŸÎ£\nÎ¨Î¥Î§Î™ÎšÎŸ,2,Î£Î¤1,Î™Î£Î¤ÎŸÎ¡Î™Î‘,Î“Î™Î‘ÎÎÎ‘ÎšÎ— Î‘ÎÎÎ‘\nÎ¨Î¥Î§Î™ÎšÎŸ,2,Î£Î¤1,ÎšÎ‘Î›Î›Î™Î¤Î•Î§ÎÎ™ÎšÎ‘,Î‘Î“Î“Î•Î›ÎŸÎ¥ Î¤Î–Î©Î¡Î¤Î–Î™ÎÎ‘\nÎ¨Î¥Î§Î™ÎšÎŸ,2,Î£Î¤1,ÎšÎ Î‘,Î“Î™Î‘ÎÎÎ‘ÎšÎ— Î‘ÎÎÎ‘\nÎ¨Î¥Î§Î™ÎšÎŸ,2,Î£Î¤1,ÎœÎ‘Î˜Î—ÎœÎ‘Î¤Î™ÎšÎ‘,Î Î•Î¤Î¡Î‘ÎšÎ—Î£ Î“Î•Î©Î¡Î“Î™ÎŸÎ£\nÎ¨Î¥Î§Î™ÎšÎŸ,2,Î£Î¤1,ÎœÎŸÎ¥Î£Î™ÎšÎ—,Î’ÎŸÎ¤Î‘ÎÎŸÎ ÎŸÎ¥Î›ÎŸÎ¥ Î•Î¥Î“Î•ÎÎ™Î‘\nÎ¨Î¥Î§Î™ÎšÎŸ,2,Î£Î¤1,ÎœÎ£/Î”Î£,Î Î•Î¤Î¡Î‘ÎšÎ—Î£ Î“Î•Î©Î¡Î“Î™ÎŸÎ£\nÎ¨Î¥Î§Î™ÎšÎŸ,2,Î£Î¤1,Î Î›Î—Î¡ÎŸÎ¦ÎŸÎ¡Î™ÎšÎ—,Î‘ÎÎ”Î¡Î™ÎŸÎ ÎŸÎ¥Î›ÎŸÎ¥ Î”Î—ÎœÎ—Î¤Î¡Î‘\nÎ¨Î¥Î§Î™ÎšÎŸ,2,Î£Î¤1,Î¦Î™Î›Î‘ÎÎ‘Î“ÎÎ©Î£Î™Î‘,Î“Î™Î‘ÎÎÎ‘ÎšÎ— Î‘ÎÎÎ‘\nÎ¨Î¥Î§Î™ÎšÎŸ,2,Î£Î¤1,Î¦Î¥Î£Î™ÎšÎ—,Î§Î©Î¡Î™Î‘ÎÎŸÎ ÎŸÎ¥Î›ÎŸÎ£ ÎšÎ©ÎÎ£Î¤Î‘ÎÎ¤Î™ÎÎŸÎ£`;

        const TARGET_TOTAL_HOURS = 40;
        const MULTI_TEACHER_SUBJECTS = ["Î‘Î“Î“Î›Î™ÎšÎ‘", "Î“Î‘Î›Î›Î™ÎšÎ‘", "Î“Î•Î¡ÎœÎ‘ÎÎ™ÎšÎ‘"];

        // State & Maps
        let schoolStructure = {}; 
        let rulesMap = {}; 
        let assignmentsState = {}; 
        
        let teachersBySchool = {}; 
        let specialtiesBySchool = {}; 
        let restrictedSubjects = new Set(); 

        // --- PARSING HELPERS ---
        function parseList(text) { 
            if (!text) return [];
            return text.trim().split('\n').map(s => s.trim()).filter(s => s !== ""); 
        }

        function parseSchoolStructure() {
            const lines = parseList(RAW_SCHOOL_MAPPINGS);
            const regionSelect = document.getElementById('region-select');
            
            lines.forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 2) {
                    const region = parts[0].trim();
                    const schools = parts.slice(1).map(s => s.trim());
                    schoolStructure[region] = schools;
                    
                    const opt = document.createElement('option');
                    opt.value = region;
                    opt.innerText = region;
                    regionSelect.appendChild(opt);
                }
            });
        }

        function parseRules() {
            const lines = parseList(RAW_HOURS_RULES);
            lines.forEach(line => {
                const parts = line.split(',');
                const subject = parts[0].trim();
                const hours = parts.slice(1).map(Number);
                if (hours.length === 6) rulesMap[subject] = hours;
            });
        }

        function parseTeachers() {
            // NOTE: RAW_TEACHERS now comes from window object (external file)
            const lines = parseList(window.RAW_TEACHERS);
            lines.forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 3) {
                    const region = parts[0].trim();
                    const school = parts[1].trim();
                    const name = parts[2].trim();
                    const key = `${region}|${school}`;
                    
                    if (!teachersBySchool[key]) teachersBySchool[key] = [];
                    teachersBySchool[key].push(name);
                }
            });
            for (const key in teachersBySchool) {
                teachersBySchool[key].sort((a, b) => a.localeCompare(b, 'el'));
            }
        }

        function parseTeacherMappings() {
            // NOTE: RAW_TEACHER_MAPPINGS now comes from window object (external file)
            const lines = parseList(window.RAW_TEACHER_MAPPINGS);
            lines.forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 4) {
                    const region = parts[0].trim();
                    const school = parts[1].trim();
                    const teacher = parts[2].trim();
                    const subject = parts[3].trim();
                    const key = `${region}|${school}`;

                    if (!specialtiesBySchool[key]) specialtiesBySchool[key] = {};
                    if (!specialtiesBySchool[key][teacher]) specialtiesBySchool[key][teacher] = new Set();
                    
                    specialtiesBySchool[key][teacher].add(subject);
                    restrictedSubjects.add(subject); 
                }
            });
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================
        function initApp() {
            parseSchoolStructure();
            parseRules();
            parseTeachers();
            parseTeacherMappings();

            const subjects = parseList(RAW_SUBJECTS);
            const days = RAW_DAYS.split(',').map(s => s.trim());
            const times = parseList(RAW_TIMES);

            const headerRow = document.getElementById('header-row');
            days.forEach(day => {
                const th = document.createElement('th');
                th.innerText = day;
                headerRow.appendChild(th);
            });

            const tbody = document.getElementById('table-body');
            times.forEach(timeLabel => {
                const tr = document.createElement('tr');
                const tdTime = document.createElement('td');
                tdTime.innerText = timeLabel;
                tr.appendChild(tdTime);

                for (let i = 1; i < days.length; i++) {
                    const td = document.createElement('td');
                    const select = createDropdown(subjects, "subject-select");
                    
                    select.onchange = function(e) {
                        if (this.classList.contains('multi-selected')) {
                            const newVal = this.value;
                            const allSelected = document.querySelectorAll('.subject-select.multi-selected');
                            allSelected.forEach(sel => {
                                sel.value = newVal;
                                sel.classList.remove('multi-selected'); 
                            });
                        }
                        handleMainChange();
                    }; 
                    
                    td.appendChild(select);
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            });

            loadFromLocal();
            checkTipStatus();
        }

        // ==========================================
        // REGION & SCHOOL HANDLING
        // ==========================================
        function hasData() {
            if (Object.keys(assignmentsState).length > 0) return true;
            const selects = document.querySelectorAll('#table-body select');
            for (let s of selects) { if (s.value) return true; }
            return false;
        }

        function handleRegionChange(selectElement) {
            // Check for existing data and warn
            if (hasData()) {
                if (!confirm("Î Î¡ÎŸÎ£ÎŸÎ§Î—: Î— Î±Î»Î»Î±Î³Î® Ï€ÎµÏÎ¹Î¿Ï‡Î®Ï‚ Î¸Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹ ÏŒÎ»Î± Ï„Î± Ï„ÏÎ­Ï‡Î¿Î½Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î±.\n\nÎ˜Î­Î»ÎµÏ„Îµ Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÏ„Îµ;")) {
                    selectElement.value = selectElement.getAttribute('data-prev');
                    return;
                }
            }
            selectElement.setAttribute('data-prev', selectElement.value);

            const region = selectElement.value;
            const schoolSelect = document.getElementById('school-select');
            
            schoolSelect.innerHTML = '<option value="" disabled selected>Î£Ï‡Î¿Î»ÎµÎ¯Î¿</option>';
            schoolSelect.disabled = true;
            
            if (region && schoolStructure[region]) {
                schoolStructure[region].forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.innerText = s;
                    schoolSelect.appendChild(opt);
                });
                schoolSelect.disabled = false;
            }
            
            resetDataOnLocationChange();
        }

        function handleSchoolChange(selectElement) {
             // Check for existing data and warn
             if (hasData()) {
                if (!confirm("Î Î¡ÎŸÎ£ÎŸÎ§Î—: Î— Î±Î»Î»Î±Î³Î® ÏƒÏ‡Î¿Î»ÎµÎ¯Î¿Ï… Î¸Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹ ÏŒÎ»Î± Ï„Î± Ï„ÏÎ­Ï‡Î¿Î½Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î±.\n\nÎ˜Î­Î»ÎµÏ„Îµ Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÏ„Îµ;")) {
                    selectElement.value = selectElement.getAttribute('data-prev');
                    return;
                }
            }
            selectElement.setAttribute('data-prev', selectElement.value);

            resetDataOnLocationChange(true); // Reset data but keep location
            
            const region = document.getElementById('region-select').value;
            const school = document.getElementById('school-select').value;
            const key = `${region}|${school}`;
            const teachers = teachersBySchool[key];
            const msgBox = document.getElementById('no-teachers-msg');

            if (!teachers || teachers.length === 0) {
                msgBox.style.display = 'block';
            } else {
                msgBox.style.display = 'none';
            }
            saveToLocal();
        }

        function resetDataOnLocationChange(keepLocation = false) {
            document.getElementById('grade-select').value = "";
            document.getElementById('section-select').value = "";
            document.querySelectorAll('#table-body select').forEach(s => s.value = "");
            assignmentsState = {};
            
            handleMainChange();
            if (!keepLocation) saveToLocal(); 
        }

        function checkSelectionLocked() {
            const region = document.getElementById('region-select').value;
            const school = document.getElementById('school-select').value;
            const grade = document.getElementById('grade-select').value;
            const section = document.getElementById('section-select').value;
            
            const key = `${region}|${school}`;
            if (region && school && (!teachersBySchool[key] || teachersBySchool[key].length === 0)) {
                return true; // Permanently locked if no teachers
            }

            if (!region || !school || !grade || !section) {
                alert("âš ï¸ Î Î¡ÎŸÎ£ÎŸÎ§Î—: Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Î ÎµÏÎ¹Î¿Ï‡Î®, Î£Ï‡Î¿Î»ÎµÎ¯Î¿, Î¤Î¬Î¾Î· ÎºÎ±Î¹ Î¤Î¼Î®Î¼Î± Î³Î¹Î± Î½Î± Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÏ„Îµ!");
                
                // Visual Highlight
                const controls = document.querySelector('.controls-area');
                controls.scrollIntoView({behavior: 'smooth', block: 'center'});
                controls.style.borderColor = "var(--error-red)";
                setTimeout(() => controls.style.borderColor = "var(--primary-blue)", 2000);
                
                return true;
            }
            return false;
        }

        // ==========================================
        // UI & LOGIC HELPERS
        // ==========================================

        function createDropdown(optionsList, className) {
            const select = document.createElement('select');
            select.className = className;
            const def = document.createElement('option');
            def.value = ""; def.text = "-"; def.style.color="#999";
            select.appendChild(def);
            optionsList.forEach(opt => {
                const o = document.createElement('option');
                o.value = opt; o.text = opt;
                select.appendChild(o);
            });

            if (className === 'subject-select' || className === 'teacher-select') {
                select.addEventListener('mousedown', function(e) {
                    if (className === 'subject-select' && checkSelectionLocked()) {
                        e.preventDefault();
                        this.blur();
                        return;
                    }
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault(); 
                        this.classList.toggle('multi-selected'); 
                        setTimeout(() => this.blur(), 0); 
                    }
                });
            }

            return select;
        }

        function handleMainChange() {
            validateSchedule();
            updateAssignmentsTable();
            validateAssignments();
            saveToLocal();
        }

        function handleTeacherChange(changedSelect) {
            const newValue = changedSelect.value;
            let targets = [changedSelect];
            if (changedSelect.classList.contains('multi-selected')) {
                targets = document.querySelectorAll('.teacher-select.multi-selected');
            }

            targets.forEach(sel => {
                sel.value = newValue;
                sel.classList.remove('multi-selected');
                
                const subj = sel.getAttribute('data-subject');
                const container = sel.closest('.teacher-row-container');
                
                if (container) {
                    saveMultiTeacherState(subj, container);
                } else {
                    assignmentsState[subj] = sel.value;
                }
                
                checkTeacherSpecialty(sel, subj, sel.value);
            });

            validateAssignments();
            saveToLocal();
        }

        // ==========================================
        // KEYBOARD & NAVIGATION
        // ==========================================
        document.addEventListener('keydown', (e) => {
            if (e.key === '*') {
                e.preventDefault();
                if (confirm("âš ï¸ Î Î¡ÎŸÎ£ÎŸÎ§Î—: Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Debug Mode.\n\nÎ˜Î­Î»ÎµÏ„Îµ Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÏ„Îµ;")) {
                    fillDebug();
                }
                return;
            }

            if (e.target.tagName === 'SELECT') {
                if (e.target.classList.contains('subject-select') && ['Enter', ' ', 'ArrowDown', 'ArrowUp'].includes(e.key)) {
                    if (['Enter', ' '].includes(e.key)) {
                        if (checkSelectionLocked()) {
                            e.preventDefault();
                            return;
                        }
                    }
                }
                if (e.key === 'Enter') {
                    e.preventDefault(); 
                    try { if (e.target.showPicker) e.target.showPicker(); } catch (err) { console.log(err); }
                    return;
                }
                if (e.key === 'Delete' || e.key === 'Backspace') {
                    e.preventDefault();
                    if (e.target.classList.contains('subject-select') && checkSelectionLocked()) return; 
                    if (e.target.value !== "") {
                        e.target.value = "";
                        e.target.dispatchEvent(new Event('change'));
                    }
                    return;
                }
                if (['PageUp', 'PageDown', 'Home', 'End'].includes(e.key)) {
                    e.preventDefault(); e.target.blur();    
                    const scrollAmount = window.innerHeight * 0.8;
                    if (e.key === 'PageUp') window.scrollBy(0, -scrollAmount);
                    if (e.key === 'PageDown') window.scrollBy(0, scrollAmount);
                    if (e.key === 'Home') window.scrollTo(0, 0);
                    if (e.key === 'End') window.scrollTo(0, document.body.scrollHeight);
                    return;
                }
                if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                    e.preventDefault(); navigateGrid(e.target, e.key);
                }
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.classList.contains('subject-select') && !e.target.classList.contains('teacher-select') && !e.ctrlKey) {
                document.querySelectorAll('.multi-selected').forEach(el => el.classList.remove('multi-selected'));
            }
        });

        function navigateGrid(currentSelect, key) {
            const parentTable = currentSelect.closest('table');
            if (!parentTable) return;
            if (parentTable.id === 'schedule-table') {
                const cell = currentSelect.closest('td');
                handleScheduleNav(cell.parentElement, cell, key);
            } else if (parentTable.id === 'assignments-table') {
                handleLinearNav(currentSelect, key);
            }
        }

        function handleScheduleNav(row, cell, key) {
            const rows = Array.from(document.querySelectorAll('#table-body tr'));
            const currentRowIdx = rows.indexOf(row);
            const cells = Array.from(row.children);
            const currentColIdx = cells.indexOf(cell);
            let nextSelect = null;

            if (key === 'ArrowRight') { if (currentColIdx < cells.length - 1) nextSelect = cells[currentColIdx + 1].querySelector('select'); }
            else if (key === 'ArrowLeft') { if (currentColIdx > 1) nextSelect = cells[currentColIdx - 1].querySelector('select'); }
            else if (key === 'ArrowDown') { if (currentRowIdx < rows.length - 1) nextSelect = rows[currentRowIdx + 1].children[currentColIdx].querySelector('select'); }
            else if (key === 'ArrowUp') { if (currentRowIdx > 0) nextSelect = rows[currentRowIdx - 1].children[currentColIdx].querySelector('select'); }

            if (nextSelect && !nextSelect.disabled) nextSelect.focus();
        }

        function handleLinearNav(currentSelect, key) {
            const allSelects = Array.from(document.querySelectorAll('#assignments-body select'));
            const idx = allSelects.indexOf(currentSelect);
            if ((key === 'ArrowDown' || key === 'ArrowRight') && idx < allSelects.length - 1) allSelects[idx + 1].focus();
            else if ((key === 'ArrowUp' || key === 'ArrowLeft') && idx > 0) allSelects[idx - 1].focus();
        }
        
        // ==========================================
        // STORAGE
        // ==========================================
        function saveToLocal() {
            const region = document.getElementById('region-select').value;
            const school = document.getElementById('school-select').value;
            const grade = document.getElementById('grade-select').value;
            const section = document.getElementById('section-select').value;
            
            const scheduleData = [];
            const rows = document.getElementById('table-body').querySelectorAll('tr');
            rows.forEach(r => {
                const rowVals = [];
                r.querySelectorAll('select').forEach(s => rowVals.push(s.value));
                scheduleData.push(rowVals);
            });
            
            const dataToSave = { region, school, grade, section, schedule: scheduleData, assignments: assignmentsState };
            localStorage.setItem('arsakeiaSchedulerV1', JSON.stringify(dataToSave));
            
            const msg = document.getElementById('save-msg');
            msg.style.opacity = '1';
            setTimeout(() => { msg.style.opacity = '0'; }, 1000);
        }

        function loadFromLocal() {
            const savedData = localStorage.getItem('arsakeiaSchedulerV1');
            if (!savedData) return;
            try {
                const data = JSON.parse(savedData);
                
                // Restore Location
                if (data.region) {
                    const regionEl = document.getElementById('region-select');
                    regionEl.value = data.region;
                    // Trigger manually to populate schools
                    handleRegionChange(regionEl); 
                    
                    if (data.school) {
                        const schoolEl = document.getElementById('school-select');
                        schoolEl.value = data.school;
                        handleSchoolChange(schoolEl); 
                    }
                }

                if (data.grade) document.getElementById('grade-select').value = data.grade;
                if (data.section) document.getElementById('section-select').value = data.section;
                
                if (data.schedule && Array.isArray(data.schedule)) {
                    const rows = document.getElementById('table-body').querySelectorAll('tr');
                    data.schedule.forEach((rowVals, rIndex) => {
                        if (rIndex < rows.length) {
                            const selects = rows[rIndex].querySelectorAll('select');
                            rowVals.forEach((val, sIndex) => {
                                if (sIndex < selects.length) selects[sIndex].value = val;
                            });
                        }
                    });
                }
                
                if (data.assignments) assignmentsState = data.assignments;
                
                handleMainChange();
            } catch (e) { console.error("Error loading data", e); }
        }

        function clearAllData() {
            if (confirm("Î Î¡ÎŸÎ£ÎŸÎ§Î—: Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ ÏŒÎ»Î± Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î±;")) {
        // 1. Î”Î¹Î±Î³ÏÎ±Ï†Î® Î±Ï€ÏŒ Ï„Î·Î½ Ï„Î¿Ï€Î¹ÎºÎ® Î¼Î½Î®Î¼Î· (LocalStorage)
                localStorage.removeItem('arsakeiaSchedulerV1');

        // 2. ÎœÎ·Î´ÎµÎ½Î¹ÏƒÎ¼ÏŒÏ‚ Ï„Ï‰Î½ Î²Î±ÏƒÎ¹ÎºÏÎ½ Ï€ÎµÎ´Î¯Ï‰Î½ ÎµÏ€Î¹Î»Î¿Î³Î®Ï‚
                document.getElementById('region-select').value = "";

        // Î“Î¹Î± Ï„Î¿ ÏƒÏ‡Î¿Î»ÎµÎ¯Î¿, Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î±Î´ÎµÎ¹Î¬ÏƒÎ¿Ï…Î¼Îµ Ï„Î¹Ï‚ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚ ÎºÎ±Î¹ Î½Î± Ï„Î¿ Î±Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®ÏƒÎ¿Ï…Î¼Îµ
                const schoolSelect = document.getElementById('school-select');
                schoolSelect.innerHTML = '<option value="" disabled selected>Î£Ï‡Î¿Î»ÎµÎ¯Î¿</option>';
                schoolSelect.disabled = true;

                document.getElementById('grade-select').value = "";
                document.getElementById('section-select').value = "";

        // 3. ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ ÎµÏ€Î¹Î»Î¿Î³ÏÎ½ Î¼Î­ÏƒÎ± ÏƒÏ„Î¿Î½ Ï€Î¯Î½Î±ÎºÎ± Ï€ÏÎ¿Î³ÏÎ¬Î¼Î¼Î±Ï„Î¿Ï‚
                document.querySelectorAll('#table-body select').forEach(s => s.value = "");

        // 4. ÎœÎ·Î´ÎµÎ½Î¹ÏƒÎ¼ÏŒÏ‚ Ï„Î·Ï‚ ÎµÏƒÏ‰Ï„ÎµÏÎ¹ÎºÎ®Ï‚ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚ Î±Î½Î±Î¸Î­ÏƒÎµÏ‰Î½
                assignmentsState = {};

        // 5. Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Î·Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚ (ÎºÏÏÎ²ÎµÎ¹ Ï€Î¯Î½Î±ÎºÎµÏ‚ ÎµÎ»Î­Î³Ï‡Î¿Ï…, Î¼Î·Î´ÎµÎ½Î¯Î¶ÎµÎ¹ Î¼ÎµÏ„ÏÎ·Ï„Î­Ï‚)
                handleMainChange();

        // 6. ÎšÏÎ»Î¹ÏƒÎ· ÏƒÏ„Î·Î½ ÎºÎ¿ÏÏ…Ï†Î® Ï„Î·Ï‚ ÏƒÎµÎ»Î¯Î´Î±Ï‚ Î³Î¹Î± ÎºÎ±Î¸Î±ÏÎ® Î±ÏÏ‡Î®
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // ==========================================
        // VALIDATION & LOGIC
        // ==========================================
        // --- ÎÎ•Î‘ Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î— Î“Î™Î‘ Î¤ÎŸ Î‘ÎÎŸÎ™Î“ÎœÎ‘/ÎšÎ›Î•Î™Î£Î™ÎœÎŸ ---
        
        function toggleValidation() {
            const content = document.getElementById('validation-content');
            const header = document.querySelector('.validation-header');
            const arrow = document.getElementById('validation-arrow');

            if (content.style.display === 'block') {
                content.style.display = 'none';
                header.classList.remove('open');
                arrow.classList.remove('rotate');
            } else {
                content.style.display = 'block';
                header.classList.add('open');
                arrow.classList.add('rotate');
            }
        }

        // --- LOGIC Î“Î™Î‘ Î¤ÎŸ INFO TIP ---
        function checkTipStatus() {
    // Î•Î»Î­Î³Ï‡Î¿Ï…Î¼Îµ Î±Î½ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Ï„Î¿ Î­Ï‡ÎµÎ¹ ÎºÎ»ÎµÎ¯ÏƒÎµÎ¹ ÏƒÏ„Î¿ Ï€Î±ÏÎµÎ»Î¸ÏŒÎ½
            const isHidden = localStorage.getItem('hideMultiSelectTip');
            const tipBox = document.getElementById('multi-select-tip');

            if (!isHidden && tipBox) {
        tipBox.style.display = 'flex'; // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î±Î½ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Ï„ÎµÎ¯ Ï„Î¿ 'hide'
    } else if (tipBox) {
        tipBox.style.display = 'none';
    }
}

function dismissTip() {
    const tipBox = document.getElementById('multi-select-tip');
    if (tipBox) {
        tipBox.style.display = 'none';
        // Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï„Î·Ï‚ ÎµÏ€Î¹Î»Î¿Î³Î®Ï‚ Î³Î¹Î± Ï€Î¬Î½Ï„Î±
        localStorage.setItem('hideMultiSelectTip', 'true');
    }
}


// --- Î¤Î¡ÎŸÎ ÎŸÎ ÎŸÎ™Î—ÎœÎ•ÎÎ— Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î— VALIDATION (ME SCORE X/Y) ---
        function validateSchedule() {
    const grade = document.getElementById('grade-select').value;
    const footerHours = document.getElementById('status-hours');
    const footerSubj = document.getElementById('status-subjects'); 
    
    // Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± UI
    const reportDiv = document.getElementById('validation-report');
    const gridDiv = document.getElementById('validation-grid');
    const scoreBadge = document.getElementById('validation-score-badge');

    if (!grade) { 
        reportDiv.style.display = 'none'; 
        footerHours.innerHTML = `<span>Î©Î¡Î•Î£: 0/${TARGET_TOTAL_HOURS}</span>`;
        footerHours.className = 'status-box warning';
        footerSubj.innerHTML = `<span>ÎœÎ‘Î˜Î—ÎœÎ‘Î¤Î‘: -</span>`;
        footerSubj.className = 'status-box warning';
        return; 
    }

    reportDiv.style.display = 'block';
    gridDiv.innerHTML = '';
    
    const gradeMap = { 'Î‘':0, 'Î’':1, 'Î“':2, 'Î”':3, 'Î•':4, 'Î£Î¤':5 };
    const idx = gradeMap[grade];
    const selects = document.querySelectorAll('.subject-select');
    const counts = {};
    let totalHours = 0;

    // ÎšÎ±Ï„Î±Î¼Î­Ï„ÏÎ·ÏƒÎ· Ï‰ÏÏÎ½ Ï€Î¿Ï… Î­Ï‡Î¿Ï…Î½ Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯ ÏƒÏ„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î±
    selects.forEach(sel => {
        if(sel.value) { counts[sel.value] = (counts[sel.value]||0)+1; totalHours++; }
    });

    footerHours.innerHTML = `<span>Î©Î¡Î•Î£: ${totalHours}/${TARGET_TOTAL_HOURS}</span>`;
    footerHours.className = (totalHours === TARGET_TOTAL_HOURS) ? 'status-box success' : 'status-box warning';

    // --- Î¥Î ÎŸÎ›ÎŸÎ“Î™Î£ÎœÎŸÎ£ Î£ÎšÎŸÎ¡ (Î§Î©Î¡Î™Î£ Î¤Î‘ 0/0) ---
    let correctRules = 0;   
    let totalRules = 0;     

    for (const [subj, hoursArr] of Object.entries(rulesMap)) {
        const req = hoursArr[idx];
        const act = counts[subj] || 0;

        // --- Î’Î‘Î£Î™ÎšÎ— Î‘Î›Î›Î‘Î“Î— ---
        // Î‘Î½ Ï„Î¿ Î¼Î¬Î¸Î·Î¼Î± Î´ÎµÎ½ Ï€ÏÎ¿Î²Î»Î­Ï€ÎµÏ„Î±Î¹ (0 ÏÏÎµÏ‚) ÎšÎ‘Î™ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Î´Î·Î»Ï‰Î¸ÎµÎ¯ (0 ÏÏÎµÏ‚),
        // Ï„Î¿ Ï€ÏÎ¿ÏƒÏ€ÎµÏÎ½Î¬Î¼Îµ Ï„ÎµÎ»ÎµÎ¯Ï‰Ï‚. Î”ÎµÎ½ Î¼ÎµÏ„ÏÎ¬ÎµÎ¹ ÏƒÏ„Î¿ ÏƒÎºÎ¿Ï, Î¿ÏÏ„Îµ ÎµÎ¼Ï†Î±Î½Î¯Î¶ÎµÏ„Î±Î¹.
        if (req === 0 && act === 0) continue;

        // Î‘Î½ Ï†Ï„Î¬ÏƒÎ±Î¼Îµ ÎµÎ´Ï, ÏƒÎ·Î¼Î±Î¯Î½ÎµÎ¹ ÏŒÏ„Î¹ ÎµÎ¯Ï„Îµ Ï„Î¿ Î¼Î¬Î¸Î·Î¼Î± Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ ÏÏÎµÏ‚ (req > 0),
        // ÎµÎ¯Ï„Îµ Î­Î³Î¹Î½Îµ Î»Î¬Î¸Î¿Ï‚ ÎºÎ±Î¹ Î¼Ï€Î®ÎºÎ±Î½ ÏÏÎµÏ‚ ÎµÎ½Ï Î´ÎµÎ½ Î­Ï€ÏÎµÏ€Îµ (req=0, act>0).
        totalRules++; 
        
        const el = document.createElement('div');
        el.className = 'validation-item';
        
        if (act === req) {
            correctRules++; 
            el.classList.add('success'); 
            el.innerHTML = `<span>${subj}</span> <span>${act} / ${req} (OK)</span>`;
        } else {
            el.classList.add('error'); 
            el.innerHTML = `<span>${subj}</span> <span>${act} / ${req} (Î›Î‘Î˜ÎŸÎ£)</span>`;
        }
        gridDiv.appendChild(el);
    }

    // --- Î•ÎÎ—ÎœÎ•Î¡Î©Î£Î— Î¤Î—Î£ ÎœÎ Î‘Î¡Î‘Î£ ---
    scoreBadge.innerText = `${correctRules} / ${totalRules}`;

    if (totalRules > 0 && correctRules === totalRules) {
        scoreBadge.className = "score-badge success";
        footerSubj.innerHTML = '<span>ÎœÎ‘Î˜Î—ÎœÎ‘Î¤Î‘: OK</span>';
        footerSubj.className = 'status-box success';
    } else {
        scoreBadge.className = "score-badge error";
        footerSubj.innerHTML = '<span>ÎœÎ‘Î˜Î—ÎœÎ‘Î¤Î‘: Î›Î‘Î˜ÎŸÎ£</span>';
        footerSubj.className = 'status-box error';
    }
}

        function updateAssignmentsTable() {
            const tableBody = document.getElementById('assignments-body');
            const subjectsInSchedule = new Set();
            document.querySelectorAll('.subject-select').forEach(sel => { if (sel.value) subjectsInSchedule.add(sel.value); });
            if (subjectsInSchedule.has("Î’' ÎÎ•ÎÎ— Î“Î›Î©Î£Î£Î‘")) {
                subjectsInSchedule.delete("Î’' ÎÎ•ÎÎ— Î“Î›Î©Î£Î£Î‘"); subjectsInSchedule.add("Î“Î‘Î›Î›Î™ÎšÎ‘"); subjectsInSchedule.add("Î“Î•Î¡ÎœÎ‘ÎÎ™ÎšÎ‘");
            }
            
            tableBody.innerHTML = '';
            const uniqueSubjects = Array.from(subjectsInSchedule).sort();
            
            // Get teachers specifically for current Region/School
            const region = document.getElementById('region-select').value;
            const school = document.getElementById('school-select').value;
            const key = `${region}|${school}`;
            const teacherList = teachersBySchool[key] || [];

            uniqueSubjects.forEach(subject => {
                const row = document.createElement('tr');
                const cellSubj = document.createElement('td'); cellSubj.innerText = subject; cellSubj.style.fontWeight = 'bold'; row.appendChild(cellSubj);
                const cellTeacher = document.createElement('td');
                
                if (MULTI_TEACHER_SUBJECTS.includes(subject)) {
                    const container = document.createElement('div'); container.className = 'teacher-row-container';
                    let currentValues = assignmentsState[subject];
                    if (typeof currentValues === 'string') currentValues = [currentValues];
                    if (!Array.isArray(currentValues) || currentValues.length === 0) currentValues = [""];
                    currentValues.forEach((val, index) => { addTeacherSelectRow(container, teacherList, subject, val, index === 0); });
                    cellTeacher.appendChild(container);
                } else {
                    const select = createDropdown(teacherList, "teacher-select");
                    select.setAttribute('data-subject', subject);
                    if (assignmentsState[subject] && typeof assignmentsState[subject] === 'string') select.value = assignmentsState[subject];
                    checkTeacherSpecialty(select, subject, select.value);
                    select.onchange = function() { handleTeacherChange(this); };
                    cellTeacher.appendChild(select);
                }
                row.appendChild(cellTeacher); tableBody.appendChild(row);
            });
        }

        
        function addTeacherSelectRow(container, teacherList, subject, value, isFirst) {
            const wrapper = document.createElement('div'); 
            wrapper.className = 'teacher-input-group';

            const select = createDropdown(teacherList, "teacher-select");
            select.setAttribute('data-subject', subject); 
            select.value = value || "";
            checkTeacherSpecialty(select, subject, select.value);

            select.onchange = function() { handleTeacherChange(this); };

            wrapper.appendChild(select);

            if (isFirst) {
                // ÎšÎ¿Ï…Î¼Ï€Î¯ Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·Ï‚ (+)
                const btnAdd = document.createElement('button'); 
                btnAdd.className = 'btn-add'; 
                btnAdd.innerText = '+';
                btnAdd.onclick = function() { 
                    addTeacherSelectRow(container, teacherList, subject, "", false); 
                    saveMultiTeacherState(subject, container); 
                    validateAssignments(); 
                    saveToLocal(); 
                };
                wrapper.appendChild(btnAdd);
            } else {
                // ÎšÎ¿Ï…Î¼Ï€Î¯ Î”Î¹Î±Î³ÏÎ±Ï†Î®Ï‚ (x) Î¼Îµ Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·
                const btnRemove = document.createElement('button'); 
                btnRemove.className = 'btn-remove'; 
                btnRemove.innerText = 'x';

                btnRemove.onclick = function() { 
                    const teacherName = select.value; // Î Î±Î¯ÏÎ½Î¿Ï…Î¼Îµ Ï„Î¿ ÏŒÎ½Î¿Î¼Î± Ï„Î¿Ï… ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿Ï
                    
                    // Î‘Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿Ï‚ ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏŒÏ‚, Î¶Î·Ï„Î¬Î¼Îµ ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·
                    if (teacherName && teacherName.trim() !== "") {
                        const confirmed = confirm(`Î˜Î­Î»ÎµÏ„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Ï„Î·Î½ Î±Î½Î¬Î¸ÎµÏƒÎ·: ${teacherName};`);
                        if (!confirmed) {
                            return; // Î‘Î½ Ï€Î±Ï„Î®ÏƒÎµÎ¹ "Î‘ÎºÏÏÏ‰ÏƒÎ·", ÏƒÏ„Î±Î¼Î±Ï„Î¬Î¼Îµ ÎµÎ´Ï.
                        }
                    }
                    
                    // Î ÏÎ¿Ï‡Ï‰ÏÎ¬Î¼Îµ ÏƒÏ„Î· Î´Î¹Î±Î³ÏÎ±Ï†Î®
                    container.removeChild(wrapper); 
                    saveMultiTeacherState(subject, container); 
                    validateAssignments(); 
                    saveToLocal(); 
                };
                
                wrapper.appendChild(btnRemove);
            }
            container.appendChild(wrapper);
        }

        
        function saveMultiTeacherState(subject, container) {
            const values = []; container.querySelectorAll('select').forEach(sel => { values.push(sel.value); });
            assignmentsState[subject] = values;
        }

        function checkTeacherSpecialty(selectElement, subject, teacherName) {
            if (!teacherName) { selectElement.classList.remove('teacher-mismatch'); return; }
            
            const region = document.getElementById('region-select').value;
            const school = document.getElementById('school-select').value;
            const key = `${region}|${school}`;
            
            // Check if ANY mappings exist for this school. If not, don't show errors.
            if (!specialtiesBySchool[key] || Object.keys(specialtiesBySchool[key]).length === 0) return;

            let isError = false;
            // Check if teacher has specific specialties listed
            if (specialtiesBySchool[key][teacherName]) {
                 if (!specialtiesBySchool[key][teacherName].has(subject)) isError = true;
            } else {
                // If teacher is NOT in the mappings list, but the subject IS restricted (e.g. Physics)
                // then mark as error. If the subject is not restricted (not in mapping list at all), assume OK.
                if (restrictedSubjects.has(subject)) isError = true;
            }
            
            if (isError) selectElement.classList.add('teacher-mismatch'); else selectElement.classList.remove('teacher-mismatch');
        }

        function validateAssignments() {
            const warningBox = document.getElementById('assignment-warning');
            const footerAssign = document.getElementById('status-assign');
            let hasMissing = false;
            let totalSubjects = 0; let assignedSubjects = 0;
            const assignRows = document.getElementById('assignments-body').querySelectorAll('tr');
            assignRows.forEach(row => {
                totalSubjects++;
                let hasTeacher = false;
                const selects = row.querySelectorAll('select');
                selects.forEach(s => { if (s.value) hasTeacher = true; });
                if (hasTeacher) assignedSubjects++; else hasMissing = true;
                selects.forEach(s => { if (!s.value) s.classList.add('missing-assignment'); else s.classList.remove('missing-assignment'); });
            });
            if (hasMissing) warningBox.style.display = 'block'; else warningBox.style.display = 'none';
            footerAssign.innerHTML = `<span>Î‘ÎÎ‘Î˜Î•Î£Î•Î™Î£: ${assignedSubjects}/${totalSubjects}</span>`;
            footerAssign.className = (totalSubjects > 0 && assignedSubjects === totalSubjects) ? 'status-box success' : 'status-box warning';
        }

        // ==========================================
        // IMPORT / EXPORT / DEBUG
        // ==========================================
        function fillDebug() {
            const regionEl = document.getElementById('region-select');
            regionEl.value = 'Î¨Î¥Î§Î™ÎšÎŸ';
            handleRegionChange(regionEl);
            
            const schoolEl = document.getElementById('school-select');
            schoolEl.value = '2';
            handleSchoolChange(schoolEl);
            
            document.getElementById('grade-select').value = 'Î£Î¤';
            document.getElementById('section-select').value = '1';

            const scheduleRows = parseList(DEBUG_DATA_CSV).slice(1);
            const tableRows = document.getElementById('table-body').querySelectorAll('tr');
            for(let i=0; i<Math.min(scheduleRows.length, tableRows.length); i++) {
                const parts = scheduleRows[i].split(',');
                const selects = tableRows[i].querySelectorAll('select');
                for(let j=0; j<selects.length; j++) { if (j+1 < parts.length) { let val = parts[j+1].trim(); if(val.includes("Î’Î„")) val = val.replace("Î’Î„", "Î’'"); selects[j].value = val; } }
            }
            
            const assignLines = parseList(DEBUG_ASSIGNMENTS_CSV);
            assignLines.forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 5) {
                    const r = parts[0].trim();
                    const s = parts[1].trim();
                    if (r === 'Î¨Î¥Î§Î™ÎšÎŸ' && s === '2') {
                        const subj = parts[3].trim(); 
                        const teachers = parts.slice(4).map(t => t.trim());
                        if (teachers.length > 1) assignmentsState[subj] = teachers; else assignmentsState[subj] = teachers[0];
                    }
                }
            });
            handleMainChange(); 
        }

        function triggerImport() { document.getElementById('csv-input').click(); }
        function handleFileSelect(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader(); reader.onload = function(e) { importCSV(e.target.result); }; reader.readAsText(file);
        }

        function importCSV(csvText) {
            // Clear current table data before importing new
            document.querySelectorAll('#table-body select').forEach(s => s.value = "");
            assignmentsState = {};

            let lines = csvText.trim().split('\n').map(l => l.trim()).filter(l => l !== "");
            
            if (lines.length > 0 && lines[0].startsWith("#STATUS REPORT")) lines.shift();

            let rowIndex = 0; 
            const tableRows = document.getElementById('table-body').querySelectorAll('tr');
            
            let foundLocation = false;

            // Scan for assignments first to set location
            for(let i=0; i<lines.length; i++) {
                const parts = parseCSVLine(lines[i]);
                if (parts.length >= 5 && !parts[0].includes(":")) {
                     const r = parts[0];
                     const s = parts[1];
                     const c = parts[2];
                     
                     // Validate Region exists in structure (fixes Header Row Bug)
                     if (r && s && c && schoolStructure[r]) {
                        const regionEl = document.getElementById('region-select');
                        regionEl.value = r;
                        handleRegionChange(regionEl); // Populates school list
                        
                        const schoolEl = document.getElementById('school-select');
                        schoolEl.value = s;
                        handleSchoolChange(schoolEl); // Checks teachers
                        
                        let g = "", sec = "";
                        if (c.startsWith("Î£Î¤")) { g = "Î£Î¤"; sec = c.substring(2); } else { g = c.substring(0, 1); sec = c.substring(1); }
                        document.getElementById('grade-select').value = g;
                        document.getElementById('section-select').value = sec;
                        foundLocation = true;
                        break;
                     }
                }
            }
            
            if (!foundLocation) {
                 alert("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÏƒÏ‡Î¿Î»ÎµÎ¯Î¿Ï… ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿. Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î± Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î±.");
            }

            for (let i = 1; i < lines.length; i++) { 
                const line = lines[i]; if (!line) continue;
                const rowValues = parseCSVLine(line);
                const firstCol = rowValues[0];
                const isTime = firstCol && firstCol.includes(":"); 

                if (isTime && rowIndex < tableRows.length) {
                    const selects = tableRows[rowIndex].querySelectorAll('select');
                    for(let j=0; j<selects.length; j++) { if (j+1 < rowValues.length) selects[j].value = rowValues[j+1]; }
                    rowIndex++;
                } else if (!isTime && rowValues.length >= 5) {
                    const r = rowValues[0];
                    if (schoolStructure[r]) { // Valid assignment line
                        const subj = rowValues[3]; 
                        const teachers = rowValues.slice(4);
                        if (teachers.length > 1) assignmentsState[subj] = teachers; else assignmentsState[subj] = teachers[0];
                    }
                }
            }
            handleMainChange(); alert("Î•Ï€Î¹Ï„Ï…Ï‡Î®Ï‚ Î•Î¹ÏƒÎ±Î³Ï‰Î³Î®!"); document.getElementById('csv-input').value = ''; 
        }

        function parseCSVLine(line) {
            const values = []; let current = ''; let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes; else if (char === ',' && !inQuotes) { values.push(current); current = ''; } else current += char;
            }
            values.push(current); return values.map(v => v.trim().replace(/^"|"$/g, ''));
        }

        function exportToCSV() {
            const region = document.getElementById('region-select').value;
            const school = document.getElementById('school-select').value;
            const grade = document.getElementById('grade-select').value;
            const section = document.getElementById('section-select').value;
            
            if (!region || !school || !grade || !section) { alert("Î Î±ÏÎ±ÎºÎ±Î»Ï ÏƒÏ…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ ÏŒÎ»Î± Ï„Î± Ï€ÎµÎ´Î¯Î± Ï€ÏÎ¹Î½ Ï„Î·Î½ ÎµÎ¾Î±Î³Ï‰Î³Î®!"); return; }
            
            const hoursOK = document.getElementById('status-hours').classList.contains('success');
            const subjOK = document.getElementById('status-subjects').classList.contains('success');
            const assignOK = document.getElementById('status-assign').classList.contains('success');
            const isComplete = hoursOK && subjOK && assignOK;

            let teacherName = ""; let greekTeacher = assignmentsState["Î•Î›Î›Î—ÎÎ™ÎšÎ‘"];
            if (Array.isArray(greekTeacher) && greekTeacher.length > 0) teacherName = greekTeacher[0];
            else if (typeof greekTeacher === 'string' && greekTeacher.trim() !== "") teacherName = greekTeacher;
            if (teacherName) { const nameParts = teacherName.split(' '); if (nameParts.length > 0) teacherName = nameParts[0]; }
            
            // Î Î±Î»Î¹ÏŒ: Î‘Î»Î»Î±Î³Î® Î±Ï€ÏŒ csv --> text Î³Î¹Î± Î½Î± Î³Î»Î¹Ï„ÏÏƒÏ‰ Î±Ï€ÏŒ Ï„Î¿Ï…Ï‚ Î¬ÏƒÏ‡ÎµÏ„Î¿Ï…Ï‚ Ï€Î¿Ï… Î¸Î± Î±Î½Î¿Î¯Î¾Î¿Ï…Î½ ÏƒÎµ excel
            //let fileName = `${region}_${school}_${grade}${section}_schedule.csv`; 
            //if (teacherName) fileName = `${region}_${school}_${grade}${section}_${teacherName}_schedule.csv`;
            //if (!isComplete) fileName = fileName.replace(".csv", "_INCOMPLETE.csv");

            // ÎÎ•ÎŸ:
            let fileName = `${region}_${school}_${grade}${section}_schedule.txt`; // Î‘Î»Î»Î±Î³Î® ÏƒÎµ .txt
            if (teacherName) fileName = `${region}_${school}_${grade}${section}_${teacherName}_schedule.txt`;
            if (!isComplete) fileName = fileName.replace(".txt", "_INCOMPLETE.txt");


            const className = `${grade}${section}`;
            let csvContent = ""; 

            if (!isComplete) {
                const hTxt = document.getElementById('status-hours').innerText;
                const sTxt = document.getElementById('status-subjects').innerText;
                const aTxt = document.getElementById('status-assign').innerText;
                csvContent += `#STATUS REPORT: ${hTxt} | ${sTxt} | ${aTxt}\n`;
            }

            const days = RAW_DAYS.split(',').map(s => s.trim()); csvContent += days.join(",") + "\n";
            const scheduleRows = document.getElementById('table-body').querySelectorAll('tr');
            scheduleRows.forEach(r => {
                let rowData = []; rowData.push(r.cells[0].innerText);
                r.querySelectorAll('select').forEach(sel => { let v = sel.value; if(v.includes(",")) v = `"${v}"`; rowData.push(v); });
                csvContent += rowData.join(",") + "\n";
            });
            csvContent += "\n\n";
            
            // --- NEW EXPORT FORMAT FOR ASSIGNMENTS ---
            const assignRows = document.getElementById('assignments-body').querySelectorAll('tr');
            assignRows.forEach(r => {
                const subject = r.cells[0].innerText; 
                let teachers = [];
                r.querySelectorAll('select').forEach(sel => { if (sel.value) teachers.push(sel.value); });
                teachers.sort((a, b) => a.localeCompare(b, 'el'));
                
                if (teachers.length > 0) {
                    // FORMAT: REGION,SCHOOL,CLASS,SUBJECT,TEACHER1...
                    let lineParts = [region, school, className, subject, ...teachers];
                    let csvLine = lineParts.map(part => part.includes(",") ? `"${part}"` : part).join(",");
                    csvContent += csvLine + "\n";
                }
            });
            
            // --------------------- Î Î±Î»Î¹Î¬ ÎµÎ½Ï„Î¿Î»Î® Ï€Î¿Ï… ÎºÎ±Ï„Î­Î²Î±Î¶Îµ type csv Î±Î»Î»Î¬ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÏƒÎµÎ½Î¬ÏÎ¹Î¿ Î½Î± Ï€ÏÎ¿Ï„ÎµÎ¯Î½ÎµÎ¹ Î¿ browser open with excel
            // const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });

            // ÎÎ•ÎŸ BLOB:
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = fileName;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        // Initialize with External Loader
        window.onload = loadExternalData;
    </script>
</body>
</html>
